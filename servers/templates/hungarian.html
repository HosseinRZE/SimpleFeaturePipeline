<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Hungarian LSTM Predictor</title>
<script src="https://unpkg.com/lightweight-charts@5.0.8/dist/lightweight-charts.standalone.production.js"></script>
<style>
html, body { height:100%; margin:0; background:#111827; color:#f3f4f6; font-family:system-ui; }
#chart { height:calc(100% - 6rem); }
#controls { height:6rem; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; gap:0.5rem; padding:0.5rem 1rem; background:#1f2937; color:#fff; }
button { padding:.5rem 1rem; border:none; border-radius:.25rem; background:#3b82f6; color:#fff; cursor:pointer; }
#seqCheckboxes { display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.5rem; }
#seqCheckboxes label { display:flex; align-items:center; gap:0.25rem; cursor:pointer; font-size:14px; }
#addSeq { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; }
#infoBox { position:absolute; top:10px; left:10px; z-index:1000; padding:8px 12px;
           background:rgba(0,0,0,.7); color:#fff; border-radius:4px; font-family:monospace;
           font-size:13px; line-height:1.4; display:none; }
</style>
</head>
<body>

<div id="chart"></div>

<div id="controls">
    <div>
        <button id="nextBtn">Next Candle (Space)</button>
        <label><input type="checkbox" id="showTitles" checked> Show line info</label>
    </div>
    <div id="seqCheckboxes">
        <label><input type="checkbox" value="3" checked> seq:3</label>
        <label><input type="checkbox" value="5" checked> seq:5</label>
        <label><input type="checkbox" value="8" checked> seq:8</label>
        <label><input type="checkbox" value="13" checked> seq:13</label>
        <label><input type="checkbox" value="20" checked> seq:20</label>
    </div>
    <div id="addSeq">
        <input type="number" id="newSeqInput" placeholder="New seq" min="1"/>
        <button id="addSeqBtn">Add Sequence</button>
    </div>
</div>

<div id="infoBox"></div>

<script>
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    width: window.innerWidth,
    height: window.innerHeight - 120,
    layout: { background: { type:'solid', color:'#111827' }, textColor:'#d1d5db' },
    grid: { vertLines:{color:'#374151'}, horzLines:{color:'#374151'} }
});
const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, { upColor:'#22c55e', downColor:'#ef4444', borderVisible:false });

window.predictionLines = [];
let nextIdx = 0;

// ---------- Load initial candles ----------
fetch('/get_and_add_data').then(r=>r.json()).then(data=>{
    candleSeries.setData(data.candles);
    nextIdx = data.next_idx;
    chart.timeScale().fitContent();
});

// ---------- Color scale helper ----------
function getColorForIndex(i, total) {
    const start = [250, 204, 21];  // bright yellow
    const end = [239, 68, 68];     // red
    const t = total > 1 ? i / (total - 1) : 0; // normalize
    const r = Math.round(start[0] * (1-t) + end[0] * t);
    const g = Math.round(start[1] * (1-t) + end[1] * t);
    const b = Math.round(start[2] * (1-t) + end[2] * t);
    return `rgba(${r},${g},${b},0.85)`;
}

// ---------- Advance ----------
function advanceOneCandle() {
    fetch(`/get_and_add_data?idx=${nextIdx}`)
        .then(r => r.json())
        .then(candleData => {
            if(candleData.error){ alert(candleData.error); return; }

            const candle = candleData.candle;
            candleSeries.update(candle);

            // clear old predictions
            window.predictionLines.forEach(l => candleSeries.removePriceLine(l));
            window.predictionLines = [];

            const seqLens = Array.from(document.querySelectorAll('#seqCheckboxes input[type=checkbox]:checked'))
                                .map(cb => parseInt(cb.value));
            const showTitles = document.getElementById('showTitles').checked;

            seqLens.forEach(seqLen => {
                fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seq_len: seqLen })
                })
                .then(r => r.json())
                .then(predData => {
                    const pred_prices = predData.pred_prices || [];
                    const total = pred_prices.length;

                    pred_prices.forEach((price, i) => {
                        const pl = candleSeries.createPriceLine({
                            price,
                            color: getColorForIndex(i, total),
                            lineWidth: 2,
                            lineStyle: LightweightCharts.LineStyle.LargeDashed,
                            axisLabelVisible: true,
                            title: showTitles ? `seq:${seqLen} line:${i}` : ''
                        });
                        window.predictionLines.push(pl);
                    });

                    if(pred_prices.length > 0){
                        showInfo(pred_prices.length, pred_prices[0]);
                    }
                })
                .catch(err => console.error('Predict fetch error:', err));
            });

            nextIdx += 1;
        })
        .catch(err => console.error('Get candle error:', err));
}

// ---------- Info box ----------
function showInfo(nPreds, firstPrice){
    document.getElementById('infoBox').textContent = 
        `Pred Lines: ${nPreds}, First Pred: ${firstPrice.toFixed(2)}`;
    document.getElementById('infoBox').style.display='block';
}

// ---------- Add new sequence ----------
document.getElementById('addSeqBtn').onclick = () => {
    const val = parseInt(document.getElementById('newSeqInput').value);
    if(!val || val < 1) return;
    const seqCheckboxes = document.getElementById('seqCheckboxes');

    if(Array.from(seqCheckboxes.querySelectorAll('input')).some(cb => parseInt(cb.value)===val)) return;

    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type='checkbox';
    cb.value=val;
    cb.checked=true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(` seq:${val}`));
    seqCheckboxes.appendChild(label);

    document.getElementById('newSeqInput').value='';
}

// ---------- Controls ----------
document.getElementById('nextBtn').onclick = advanceOneCandle;
document.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); advanceOneCandle(); }});
</script>

</body>
</html>

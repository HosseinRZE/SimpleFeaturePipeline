<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OHLCV Labeling Progressive Load</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body {
    background: #1e222d;
    color: #d1d4dc;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0; padding: 20px;
  }
  #chart {
    height: 500px;
    border: 1px solid #2a2e39;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  button, label {
    cursor: pointer;
    margin-right: 10px;
  }
  .controls {
    margin-bottom: 10px;
  }
  .csv-display {
    background: #2a2e39;
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
  <h1>OHLCV Labeling with Progressive Candles</h1>
  <div class="controls">
    <label>
      Load CSV:
      <input type="file" id="csvFile" accept=".csv" />
    </label>
    <button id="undoBtn" disabled>Undo Last Letter</button>
    <button id="nextBtn" disabled>Next Candle (Space)</button>
    <button id="exportBtn" disabled>Export CSV</button>
  </div>
  <div id="chart"></div>
  <div>
    <div>Current Candle: <span id="currentCandle">-</span></div>
    <div>Close Price: <span id="closePrice">-</span></div>
    <div>Letters Added: <span id="lettersCount">0</span></div>
    <div>Press keys (a-z) to add labels</div>
  </div>
  <h3>CSV Log (last 10 lines):</h3>
  <div class="csv-display" id="csvLog"></div>

<script>
(() => {
  const chartContainer = document.getElementById('chart');
  const chart = LightweightCharts.createChart(chartContainer, {
    layout: {
      background: { color: '#131722' },
      textColor: '#d1d4dc',
    },
    grid: {
      vertLines: { color: '#2a2e39' },
      horzLines: { color: '#2a2e39' },
    },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor: '#2a2e39' },
    timeScale: {
      borderColor: '#2a2e39',
      timeVisible: true,
      secondsVisible: false,
    },
  });

  const candleSeries = chart.addCandlestickSeries({
    upColor: '#26a69a',
    downColor: '#ef5350',
    borderVisible: false,
    wickUpColor: '#26a69a',
    wickDownColor: '#ef5350',
  });

  let allRows = [];
  let currentIndex = 0;
  let csvData = [];
  let letters = [];
  let markers = [];

  const currentCandleEl = document.getElementById('currentCandle');
  const closePriceEl = document.getElementById('closePrice');
  const lettersCountEl = document.getElementById('lettersCount');
  const csvLogEl = document.getElementById('csvLog');
  const nextBtn = document.getElementById('nextBtn');
  const undoBtn = document.getElementById('undoBtn');
  const exportBtn = document.getElementById('exportBtn');
  const csvFileInput = document.getElementById('csvFile');

  csvFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: results => {
        allRows = results.data
          .filter(r => r.timestamp && r.open != null)
          .map(r => ({
            time: Math.floor(new Date(r.timestamp).getTime() / 1000),
            open: +r.open,
            high: +r.high,
            low: +r.low,
            close: +r.close,
            volume: +r.volume || 0,
          }));
        if (allRows.length === 0) {
          alert('No valid data found in CSV.');
          return;
        }
        currentIndex = 0;
        csvData = [];
        letters = [];
        markers = [];

        // Load only the first candle
        candleSeries.setData([allRows[0]]);
        updateDisplay();

        nextBtn.disabled = false;
        undoBtn.disabled = false;
        exportBtn.disabled = false;
        updateCSVLog();
      },
    });
  });

  window.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.repeat) return;
    if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
      addLetter(e.key.toLowerCase());
    } else if (e.code === 'Space') {
      e.preventDefault();
      nextCandle();
    }
  });

  nextBtn.addEventListener('click', nextCandle);
  undoBtn.addEventListener('click', undoLastLetter);
  exportBtn.addEventListener('click', exportCSV);

  function addLetter(letter) {
    letters.push(letter);
    drawLabels();
    lettersCountEl.textContent = letters.length;
  }

  function undoLastLetter() {
    if (letters.length === 0) return;
    letters.pop();
    drawLabels();
    lettersCountEl.textContent = letters.length;
  }

  function drawLabels() {
    clearMarkers();
    if (letters.length === 0) return;
    const candle = allRows[currentIndex];
    markers = letters.map((ch, i) => ({
      time: candle.time,
      position: 'aboveBar',
      color: '#ff6b35',
      shape: 'circle',
      text: ch,
    }));
    candleSeries.setMarkers(markers);
  }

  function clearMarkers() {
    candleSeries.setMarkers([]);
    markers = [];
  }

  function nextCandle() {
    if (currentIndex >= allRows.length - 1) {
      alert('Reached end of dataset');
      nextBtn.disabled = true;
      return;
    }

    // Save labels for current candle
    const candle = allRows[currentIndex];
    const labelStr = letters.length > 0 ? letters.join(',') : '0';
    csvData.push(`${formatTimestamp(candle.time * 1000)},${candle.close},${labelStr}`);
    updateCSVLog();

    // Move to next candle
    currentIndex++;
    letters = [];
    lettersCountEl.textContent = '0';
    updateDisplay();
    clearMarkers();

    // Add next candle to chart
    candleSeries.update(allRows[currentIndex]);
  }

  function updateDisplay() {
    if (!allRows.length) return;
    const candle = allRows[currentIndex];
    currentCandleEl.textContent = formatTimestamp(candle.time * 1000);
    closePriceEl.textContent = `$${candle.close.toFixed(2)}`;
    lettersCountEl.textContent = letters.length;
  }

  function updateCSVLog() {
    const last10 = csvData.slice(-10);
    csvLogEl.textContent = last10.join('\n');
  }

  function exportCSV() {
    if (csvData.length === 0) {
      alert('No data to export');
      return;
    }
    const header = 'timestamp,close,labels\n';
    const csvContent = header + csvData.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'labeled_ohlcv.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function formatTimestamp(ms) {
    const d = new Date(ms);
    return d.toISOString().slice(0, 19).replace('T', ' ');
  }
})();
</script>
</body>
</html>
